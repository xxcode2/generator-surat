<!doctype html><html lang="id" class="h-full"> <head>  <meta charset="UTF-8">  <meta name="viewport" content="width=device-width, initial-scale=1.0">  <title>Generator Surat Desa</title>  <script src="/_sdk/element_sdk.js"></script>  <script src="/_sdk/data_sdk.js"></script>  <script src="https://cdn.tailwindcss.com"></script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>  <style>        body {            box-sizing: border-box;            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;        }                @media print {            .no-print {                display: none !important;            }            body {                background: white !important;            }            .print-page {                page-break-after: always;                margin: 0;                padding: 2cm;            }        }                .print-page {            background: white;            min-height: 29.7cm;            width: 21cm;            margin: 0 auto;            padding: 2cm;            box-shadow: 0 0 10px rgba(0,0,0,0.1);        }        .nav-button {            transition: all 0.3s ease;        }        .nav-button:hover {            transform: translateY(-2px);        }        .card-hover {            transition: all 0.3s ease;        }        .card-hover:hover {            transform: translateY(-4px);            box-shadow: 0 12px 24px rgba(0,0,0,0.15);        }        .loading {            opacity: 0.6;            pointer-events: none;        }    </style>  <style>@view-transition { navigation: auto; }</style> </head> <body class="h-full w-full bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100">  <div class="h-full w-full overflow-auto"><!-- Main Navigation -->   <nav id="mainNav" class="no-print bg-white shadow-md sticky top-0 z-50">    <div class="max-w-7xl mx-auto px-6 py-4">     <div class="flex items-center justify-between">      <div class="flex items-center space-x-3">       <div class="text-4xl">        ğŸ›ï¸       </div>       <div>        <h1 class="text-2xl font-bold text-gray-800">Generator Surat Desa</h1>        <p class="text-sm text-gray-600">Sistem Administrasi Digital</p>       </div>      </div>      <div class="flex space-x-3"><button id="btnProfil" class="nav-button bg-purple-600 text-white px-6 py-2.5 rounded-lg font-semibold shadow-md hover:bg-purple-700"> ï¿½ï¿½ï¿½ï¸ Profil </button> <button id="btnBuatSurat" class="nav-button bg-indigo-600 text-white px-6 py-2.5 rounded-lg font-semibold shadow-md hover:bg-indigo-700"> â• Buat Surat </button> <button id="btnArsip" class="nav-button bg-green-600 text-white px-6 py-2.5 rounded-lg font-semibold shadow-md hover:bg-green-700"> ğŸ“‚ Arsip </button>      </div>     </div>    </div>   </nav><!-- Home Section -->   <div id="homeSection" class="max-w-7xl mx-auto px-6 py-10">    <div class="grid md:grid-cols-2 gap-8 mb-10"><!-- SK Card -->     <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl shadow-xl p-8 text-white card-hover cursor-pointer" onclick="showKategori('sk')">      <div class="text-6xl mb-4">       ğŸ“œ      </div>      <h2 class="text-3xl font-bold mb-3">Surat Keputusan</h2>      <p class="text-blue-100 mb-4">Buat SK pengangkatan RT, RW, dan Perangkat Desa</p>      <div class="flex items-center text-blue-100"><span class="text-sm">Klik untuk memilih</span>       <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />       </svg>      </div>     </div><!-- Surat Keterangan Card -->     <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl shadow-xl p-8 text-white card-hover cursor-pointer" onclick="showKategori('sket')">      <div class="text-6xl mb-4">       ğŸ“‹      </div>      <h2 class="text-3xl font-bold mb-3">Surat Keterangan</h2>      <p class="text-green-100 mb-4">Buat surat keterangan domisili, usaha, dan lainnya</p>      <div class="flex items-center text-green-100"><span class="text-sm">Klik untuk memilih</span>       <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />       </svg>      </div>     </div>    </div><!-- Statistics -->    <div class="bg-white rounded-xl shadow-lg p-6">     <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“Š Statistik Surat</h3>     <div class="grid grid-cols-2 md:grid-cols-4 gap-4">      <div class="bg-blue-50 rounded-lg p-4 text-center">       <div class="text-3xl font-bold text-blue-600" id="statSK">        0       </div>       <div class="text-sm text-gray-600 mt-1">        Surat Keputusan       </div>      </div>      <div class="bg-green-50 rounded-lg p-4 text-center">       <div class="text-3xl font-bold text-green-600" id="statSKET">        0       </div>       <div class="text-sm text-gray-600 mt-1">        Surat Keterangan       </div>      </div>      <div class="bg-purple-50 rounded-lg p-4 text-center">       <div class="text-3xl font-bold text-purple-600" id="statTotal">        0       </div>       <div class="text-sm text-gray-600 mt-1">        Total Surat       </div>      </div>      <div class="bg-orange-50 rounded-lg p-4 text-center">       <div class="text-3xl font-bold text-orange-600" id="statBulanIni">        0       </div>       <div class="text-sm text-gray-600 mt-1">        Bulan Ini       </div>      </div>     </div>    </div>   </div><!-- Kategori Section -->   <div id="kategoriSection" class="hidden max-w-5xl mx-auto px-6 py-10"><button onclick="backToHome()" class="mb-6 text-gray-600 hover:text-gray-800 flex items-center">     <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />     </svg> Kembali </button>    <div id="skKategori" class="hidden">     <h2 class="text-3xl font-bold text-gray-800 mb-6">ğŸ“œ Pilih Jenis Surat Keputusan</h2>     <div class="grid md:grid-cols-3 gap-6" id="skTemplateGrid">      <div class="bg-white rounded-xl shadow-lg p-6 card-hover cursor-pointer" onclick="pilihJenisSurat('sk_rt')">       <div class="text-5xl mb-3">        ğŸ‘¤       </div>       <h3 class="text-xl font-bold text-gray-800 mb-2">SK RT</h3>       <p class="text-gray-600 text-sm">Pengangkatan Ketua RT</p>      </div>      <div class="bg-white rounded-xl shadow-lg p-6 card-hover cursor-pointer" onclick="pilihJenisSurat('sk_rw')">       <div class="text-5xl mb-3">        ğŸ‘¥       </div>       <h3 class="text-xl font-bold text-gray-800 mb-2">SK RW</h3>       <p class="text-gray-600 text-sm">Pengangkatan Ketua RW</p>      </div>      <div class="bg-white rounded-xl shadow-lg p-6 card-hover cursor-pointer" onclick="pilihJenisSurat('sk_perangkat')">       <div class="text-5xl mb-3">        ğŸ‘”       </div>       <h3 class="text-xl font-bold text-gray-800 mb-2">SK Perangkat</h3>       <p class="text-gray-600 text-sm">Pengangkatan Perangkat Desa</p>      </div>      <div class="bg-white rounded-xl shadow-lg p-6 card-hover cursor-pointer" onclick="pilihJenisSurat('sk_karang_taruna')">       <div class="text-5xl mb-3">        ğŸ¯       </div>       <h3 class="text-xl font-bold text-gray-800 mb-2">SK Karang Taruna</h3>       <p class="text-gray-600 text-sm">Pengangkatan Pengurus</p>      </div>      <div class="bg-white rounded-xl shadow-lg p-6 card-hover cursor-pointer" onclick="pilihJenisSurat('sk_pkk')">       <div class="text-5xl mb-3">        ğŸ‘©       </div>       <h3 class="text-xl font-bold text-gray-800 mb-2">SK PKK</h3>       <p class="text-gray-600 text-sm">Pengangkatan Pengurus PKK</p>      </div>      <div class="bg-white rounded-xl shadow-lg p-6 card-hover cursor-pointer" onclick="pilihJenisSurat('sk_bumdes')">       <div class="text-5xl mb-3">        ğŸ¢       </div>       <h3 class="text-xl font-bold text-gray-800 mb-2">SK BUMDes</h3>       <p class="text-gray-600 text-sm">Pengangkatan Pengurus BUMDes</p>      </div>     </div><button onclick="showAddTemplateModal('sk')" class="mt-8 w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-bold hover:from-purple-700 hover:to-pink-700 transition shadow-lg"> â• Tambah Template SK Baru </button>    </div>    <div id="sketKategori" class="hidden">     <h2 class="text-3xl font-bold text-gray-800 mb-6">ğŸ“‹ Pilih Jenis Surat Keterangan</h2>     <div class="grid md:grid-cols-3 gap-6" id="sketTemplateGrid">      <div class="bg-white rounded-xl shadow-lg p-6 card-hover cursor-pointer" onclick="pilihJenisSurat('sket_domisili')">       <div class="text-5xl mb-3">        ğŸ        </div>       <h3 class="text-xl font-bold text-gray-800 mb-2">Domisili</h3>       <p class="text-gray-600 text-sm">Keterangan tempat tinggal</p>      </div>      <div class="bg-white rounded-xl shadow-lg p-6 card-hover cursor-pointer" onclick="pilihJenisSurat('sket_usaha')">       <div class="text-5xl mb-3">        ğŸª       </div>       <h3 class="text-xl font-bold text-gray-800 mb-2">Usaha</h3>       <p class="text-gray-600 text-sm">Keterangan memiliki usaha</p>      </div>      <div class="bg-white rounded-xl shadow-lg p-6 card-hover cursor-pointer" onclick="pilihJenisSurat('sket_tidak_mampu')">       <div class="text-5xl mb-3">        ğŸ¤       </div>       <h3 class="text-xl font-bold text-gray-800 mb-2">Tidak Mampu</h3>       <p class="text-gray-600 text-sm">Keterangan ekonomi lemah</p>      </div>      <div class="bg-white rounded-xl shadow-lg p-6 card-hover cursor-pointer" onclick="pilihJenisSurat('sket_kelahiran')">       <div class="text-5xl mb-3">        ğŸ‘¶       </div>       <h3 class="text-xl font-bold text-gray-800 mb-2">Kelahiran</h3>       <p class="text-gray-600 text-sm">Keterangan kelahiran bayi</p>      </div>      <div class="bg-white rounded-xl shadow-lg p-6 card-hover cursor-pointer" onclick="pilihJenisSurat('sket_kematian')">       <div class="text-5xl mb-3">        ğŸ•Šï¸       </div>       <h3 class="text-xl font-bold text-gray-800 mb-2">Kematian</h3>       <p class="text-gray-600 text-sm">Keterangan kematian</p>      </div>      <div class="bg-white rounded-xl shadow-lg p-6 card-hover cursor-pointer" onclick="pilihJenisSurat('sket_penghasilan')">       <div class="text-5xl mb-3">        ğŸ’°       </div>       <h3 class="text-xl font-bold text-gray-800 mb-2">Penghasilan</h3>       <p class="text-gray-600 text-sm">Keterangan penghasilan</p>      </div>     </div><button onclick="showAddTemplateModal('sket')" class="mt-8 w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-bold hover:from-purple-700 hover:to-pink-700 transition shadow-lg"> â• Tambah Template Surat Keterangan Baru </button>    </div>   </div><!-- Form Section -->   <div id="formSection" class="hidden max-w-4xl mx-auto px-6 py-10">    <div class="bg-white rounded-2xl shadow-xl p-8 mb-6"><button onclick="backToKategori()" class="mb-6 text-gray-600 hover:text-gray-800 flex items-center">      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />      </svg> Kembali </button>     <div class="flex items-center mb-6">      <div class="text-4xl mr-4" id="formIcon">       ï¿½ï¿½      </div>      <div>       <h2 class="text-2xl font-bold text-gray-800" id="formTitle">Form Surat</h2>       <p class="text-gray-600" id="formSubtitle">Isi data dengan lengkap</p>      </div>     </div><!-- Nomor Surat Otomatis -->     <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-6"><label class="block text-sm font-semibold text-gray-700 mb-2">Nomor Surat (Otomatis)</label> <input type="text" id="nomorSuratAuto" readonly class="w-full px-4 py-3 bg-white border-2 border-blue-300 rounded-lg font-mono text-lg font-semibold text-blue-700">     </div><!-- Form Container -->     <div id="formContainer"></div><!-- Generate Button --> <button id="generateBtn" class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 text-white py-4 rounded-lg font-semibold hover:from-indigo-700 hover:to-blue-700 transition shadow-lg mt-6"> âœ¨ Generate Surat </button>    </div>   </div><!-- Arsip Section -->   <div id="arsipSection" class="hidden max-w-7xl mx-auto px-6 py-10"><!-- Profil Section -->    <div id="profilSection" class="hidden max-w-7xl mx-auto px-6 py-10">     <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">      <div class="flex justify-between items-center mb-6">       <div>        <h2 class="text-2xl font-bold text-gray-800">âš™ï¸ Manajemen Profil Instansi</h2>        <p class="text-gray-600">Kelola kop surat untuk berbagai instansi</p>       </div><button onclick="backToHome()" class="bg-gray-600 text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-gray-700"> Tutup </button>      </div><!-- Active Profile Selector -->      <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-xl p-6 mb-6"><label class="block text-sm font-bold text-gray-800 mb-3">ğŸ¯ Profil Aktif Saat Ini</label> <select id="activeProfilSelector" class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none font-semibold text-lg"> <option value="">Pilih Profil Aktif...</option> </select>       <p class="text-xs text-gray-600 mt-2">Profil yang dipilih akan digunakan untuk semua surat yang dibuat</p>      </div><!-- Add New Profile Button --> <button onclick="showAddProfilModal()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-bold hover:from-purple-700 hover:to-pink-700 transition shadow-lg mb-6"> â• Tambah Profil Baru </button> <!-- Profile List -->      <div id="profilList" class="space-y-4"></div><!-- Empty State -->      <div id="emptyProfil" class="hidden text-center py-12">       <div class="text-6xl mb-4">        ğŸ“‹       </div>       <p class="text-gray-500 text-lg">Belum ada profil. Tambahkan profil pertama Anda!</p>      </div>     </div>    </div><!-- Arsip Section -->    <div id="arsipSection" class="hidden max-w-7xl mx-auto px-6 py-10">     <div class="bg-white rounded-2xl shadow-xl p-8">      <div class="flex justify-between items-center mb-6">       <div>        <h2 class="text-2xl font-bold text-gray-800">ğŸ“‚ Arsip Surat</h2>        <p class="text-gray-600">Riwayat surat yang telah dibuat</p>       </div><button onclick="backToHome()" class="bg-gray-600 text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-gray-700"> Tutup </button>      </div><!-- Filter -->      <div class="mb-6 flex gap-3"><select id="filterKategori" class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"> <option value="all">Semua Kategori</option> <option value="sk">Surat Keputusan</option> <option value="sket">Surat Keterangan</option> </select> <input type="text" id="searchArsip" placeholder="Cari nama atau nomor surat..." class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">      </div><!-- Arsip List -->      <div id="arsipList" class="space-y-3"></div><!-- Empty State -->      <div id="emptyArsip" class="hidden text-center py-12">       <div class="text-6xl mb-4">        ğŸ“­       </div>       <p class="text-gray-500 text-lg">Belum ada arsip surat</p>      </div>     </div>    </div><!-- Preview & Print Section -->    <div id="previewSection" class="hidden max-w-7xl mx-auto px-6 py-10">     <div class="no-print bg-white border-b-4 border-indigo-600 py-4 px-6 flex justify-between items-center sticky top-0 z-10 shadow-md rounded-t-xl mb-6">      <h2 class="text-xl font-bold text-gray-800">ğŸ‘ï¸ Preview Surat</h2>      <div class="flex gap-3"><button id="editBtn" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition font-medium"> âœï¸ Edit </button> <button id="downloadPdfBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium"> ğŸ“¥ Download PDF </button> <button id="printBtn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium"> ğŸ–¨ï¸ Cetak </button> <button id="backFromPreview" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium"> ğŸ  Beranda </button>      </div>     </div>     <div id="suratContent" class="print-page bg-white"></div>    </div><!-- Modal Add Template -->    <div id="addTemplateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-6"><!-- Modal Add/Edit Profil -->     <div id="addProfilModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-6">      <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">       <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 rounded-t-2xl">        <h2 class="text-2xl font-bold" id="profilModalTitle">â• Tambah Profil Instansi Baru</h2>        <p class="text-purple-100 mt-1">Buat kop surat untuk Desa, Kelurahan, atau instansi lainnya</p>       </div>       <div class="p-6 space-y-6"><!-- Tipe Instansi -->        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4"><label class="block text-sm font-semibold text-gray-700 mb-3">ğŸ›ï¸ Tipe Instansi</label>         <div class="grid grid-cols-2 gap-3"><button type="button" onclick="selectTipeInstansi('desa')" class="tipe-btn border-2 border-gray-300 rounded-lg p-4 hover:border-blue-500 hover:bg-blue-50 transition" data-tipe="desa">           <div class="text-3xl mb-2">            ğŸ˜ï¸           </div>           <div class="font-bold">            Desa           </div>           <div class="text-xs text-gray-600">            Kepala Desa           </div></button> <button type="button" onclick="selectTipeInstansi('kelurahan')" class="tipe-btn border-2 border-gray-300 rounded-lg p-4 hover:border-blue-500 hover:bg-blue-50 transition" data-tipe="kelurahan">           <div class="text-3xl mb-2">            ğŸ¦…           </div>           <div class="font-bold">            Kelurahan           </div>           <div class="text-xs text-gray-600">            Lurah (Logo Garuda)           </div></button>         </div><input type="hidden" id="profilTipeInstansi">        </div><!-- Nama Profil -->        <div><label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ“ Nama Profil</label> <input type="text" id="profilNama" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Contoh: Desa Sukamaju">         <p class="text-xs text-gray-500 mt-1">Nama untuk mengidentifikasi profil ini</p>        </div>        <div class="border-t-2 border-gray-200 my-4"></div><!-- Informasi Instansi -->        <div class="space-y-4">         <h3 class="font-bold text-gray-800 text-lg">ğŸ“‹ Informasi Instansi</h3>         <div><label class="block text-sm font-semibold text-gray-700 mb-2" id="labelNamaInstansi">Nama Desa</label> <input type="text" id="profilDesaName" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Desa Sukamaju">         </div>         <div><label class="block text-sm font-semibold text-gray-700 mb-2">Nama Kecamatan</label> <input type="text" id="profilKecamatanName" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Kecamatan Cianjur">         </div>         <div><label class="block text-sm font-semibold text-gray-700 mb-2">Nama Kabupaten/Kota</label> <input type="text" id="profilKabupatenName" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Kabupaten Cianjur">         </div>         <div><label class="block text-sm font-semibold text-gray-700 mb-2">Alamat Kantor</label> <input type="text" id="profilAlamatKantor" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Jalan Raya Desa No. 123">         </div>         <div><label class="block text-sm font-semibold text-gray-700 mb-2">Kode Pos</label> <input type="text" id="profilKodePos" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="43217">         </div>         <div><label class="block text-sm font-semibold text-gray-700 mb-2" id="labelNamaPejabat">Nama Kepala Desa</label> <input type="text" id="profilNamaKepala" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="H. Ahmad Sudrajat">         </div>         <div id="logoUrlContainer"><label class="block text-sm font-semibold text-gray-700 mb-2">URL Logo (Opsional)</label> <input type="text" id="profilLogoUrl" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="https://example.com/logo.png">          <p class="text-xs text-gray-500 mt-1">Kosongkan jika tidak ada logo khusus</p>         </div>        </div>        <div class="flex gap-3 mt-6"><button onclick="saveProfilData()" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg font-bold hover:from-purple-700 hover:to-pink-700 transition shadow-lg"> ğŸ’¾ Simpan Profil </button> <button onclick="closeAddProfilModal()" class="px-6 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition"> Batal </button>        </div>       </div>      </div>     </div><!-- Modal Add Template -->     <div id="addTemplateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-6">      <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">       <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 rounded-t-2xl">        <h2 class="text-2xl font-bold">â• Tambah Template Surat Baru</h2>        <p class="text-purple-100 mt-1">Buat template surat custom sesuai kebutuhan</p>       </div>       <div class="p-6 space-y-4">        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Emoji Icon</label> <input type="text" id="newTemplateIcon" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="ğŸ“" maxlength="2">        </div>        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Nama Template</label> <input type="text" id="newTemplateName" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Contoh: Surat Keterangan Pindah">        </div>        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Deskripsi Singkat</label> <input type="text" id="newTemplateDesc" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Contoh: Keterangan pindah domisili">        </div>        <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">         <p class="text-sm text-gray-700 font-semibold mb-2">ğŸ“‹ Field Form yang akan ditampilkan:</p>         <p class="text-xs text-gray-600">Template akan otomatis memiliki field standar seperti: Nama, NIK, Tempat/Tanggal Lahir, Jenis Kelamin, Alamat, Tanggal Surat, dan field custom lainnya yang bisa Anda tambahkan di form nanti.</p>        </div>        <div class="flex gap-3 mt-6"><button onclick="saveNewTemplate()" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg font-bold hover:from-purple-700 hover:to-pink-700 transition shadow-lg"> ğŸ’¾ Simpan Template </button> <button onclick="closeAddTemplateModal()" class="px-6 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition"> Batal </button>        </div>       </div>      </div>     </div>    </div>    <script>        const defaultConfig = {            desa_name: "Desa Sukamaju",            kecamatan_name: "Kecamatan Cianjur",            kabupaten_name: "Kabupaten Cianjur",            alamat_kantor: "Jalan Raya Desa No. 123",            kode_pos: "43217",            nama_kepala_desa: "H. Ahmad Sudrajat",            logo_url: ""        };        let allSuratData = [];        let allProfilData = [];        let activeProfilId = null;        let currentEditProfilId = null;        let formData = {};        let currentJenisSurat = '';        let currentKategori = '';        let nomorSuratCounter = { sk: 0, sket: 0 };        let customTemplates = { sk: [], sket: [] };        let currentModalKategori = '';        // Garuda SVG for Kelurahan        const garudaSVG = `<svg viewBox="0 0 100 100" style="width: 80px; height: 80px;">            <g fill="#FFD700" stroke="#8B4513" stroke-width="1">                <!-- Simplified Garuda Pancasila -->                <ellipse cx="50" cy="50" rx="25" ry="30" fill="#8B4513"/>                <circle cx="45" cy="45" r="3" fill="white"/>                <circle cx="55" cy="45" r="3" fill="white"/>                <path d="M 35 40 Q 40 35 45 40" fill="none" stroke="#8B4513" stroke-width="2"/>                <path d="M 55 40 Q 60 35 65 40" fill="none" stroke="#8B4513" stroke-width="2"/>                <path d="M 30 50 L 25 60 L 30 58 Z" fill="#FFD700"/>                <path d="M 70 50 L 75 60 L 70 58 Z" fill="#FFD700"/>                <path d="M 50 75 L 45 85 L 50 83 L 55 85 Z" fill="#FFD700"/>                <ellipse cx="50" cy="60" rx="15" ry="8" fill="#DC143C"/>            </g>        </svg>`;        // Form templates        const formTemplates = {            sk_rt: [                { name: 'nama_rt', label: 'Nama RT', type: 'text', placeholder: 'Budi Santoso' },                { name: 'nik_rt', label: 'NIK', type: 'text', placeholder: '3201234567890123' },                { name: 'rt_number', label: 'RT', type: 'text', placeholder: '001' },                { name: 'rw_number', label: 'RW', type: 'text', placeholder: '005' },                { name: 'masa_bakti', label: 'Masa Bakti (tahun)', type: 'text', placeholder: '5' },                { name: 'tanggal_sk', label: 'Tanggal SK', type: 'date' }            ],            sk_rw: [                { name: 'nama_rw', label: 'Nama RW', type: 'text', placeholder: 'Hendra Gunawan' },                { name: 'nik_rw', label: 'NIK', type: 'text', placeholder: '3201234567890123' },                { name: 'rw_number', label: 'RW', type: 'text', placeholder: '005' },                { name: 'masa_bakti', label: 'Masa Bakti (tahun)', type: 'text', placeholder: '5' },                { name: 'tanggal_sk', label: 'Tanggal SK', type: 'date' }            ],            sk_perangkat: [                { name: 'nama_perangkat', label: 'Nama Perangkat', type: 'text', placeholder: 'Siti Nurhaliza' },                { name: 'nik_perangkat', label: 'NIK', type: 'text', placeholder: '3201234567890123' },                { name: 'jabatan', label: 'Jabatan', type: 'text', placeholder: 'Sekretaris Desa' },                { name: 'masa_bakti', label: 'Masa Bakti (tahun)', type: 'text', placeholder: '6' },                { name: 'tanggal_sk', label: 'Tanggal SK', type: 'date' }            ],            sk_karang_taruna: [                { name: 'nama_pengurus', label: 'Nama Pengurus', type: 'text', placeholder: 'Dedi Suryadi' },                { name: 'nik_pengurus', label: 'NIK', type: 'text', placeholder: '3201234567890123' },                { name: 'jabatan', label: 'Jabatan', type: 'text', placeholder: 'Ketua Karang Taruna' },                { name: 'masa_bakti', label: 'Masa Bakti (tahun)', type: 'text', placeholder: '3' },                { name: 'tanggal_sk', label: 'Tanggal SK', type: 'date' }            ],            sk_pkk: [                { name: 'nama_pengurus', label: 'Nama Pengurus', type: 'text', placeholder: 'Ibu Siti Aminah' },                { name: 'nik_pengurus', label: 'NIK', type: 'text', placeholder: '3201234567890123' },                { name: 'jabatan', label: 'Jabatan', type: 'text', placeholder: 'Ketua PKK' },                { name: 'masa_bakti', label: 'Masa Bakti (tahun)', type: 'text', placeholder: '5' },                { name: 'tanggal_sk', label: 'Tanggal SK', type: 'date' }            ],            sk_bumdes: [                { name: 'nama_pengurus', label: 'Nama Pengurus', type: 'text', placeholder: 'Budi Hartono' },                { name: 'nik_pengurus', label: 'NIK', type: 'text', placeholder: '3201234567890123' },                { name: 'jabatan', label: 'Jabatan', type: 'text', placeholder: 'Direktur BUMDes' },                { name: 'masa_bakti', label: 'Masa Bakti (tahun)', type: 'text', placeholder: '5' },                { name: 'tanggal_sk', label: 'Tanggal SK', type: 'date' }            ],            sket_domisili: [                { name: 'nama_lengkap', label: 'Nama Lengkap', type: 'text', placeholder: 'Andi Wijaya' },                { name: 'nik', label: 'NIK', type: 'text', placeholder: '3201234567890123' },                { name: 'tempat_lahir', label: 'Tempat Lahir', type: 'text', placeholder: 'Jakarta' },                { name: 'tanggal_lahir', label: 'Tanggal Lahir', type: 'date' },                { name: 'jenis_kelamin', label: 'Jenis Kelamin', type: 'select', options: ['Laki-laki', 'Perempuan'] },                { name: 'pekerjaan', label: 'Pekerjaan', type: 'text', placeholder: 'Wiraswasta' },                { name: 'alamat', label: 'Alamat Lengkap', type: 'textarea', placeholder: 'Jl. Mawar No. 10 RT 001 RW 005' },                { name: 'keperluan', label: 'Keperluan', type: 'text', placeholder: 'Pembuatan KTP' },                { name: 'tanggal_surat', label: 'Tanggal Surat', type: 'date' }            ],            sket_usaha: [                { name: 'nama_lengkap', label: 'Nama Lengkap', type: 'text', placeholder: 'Dewi Lestari' },                { name: 'nik', label: 'NIK', type: 'text', placeholder: '3201234567890123' },                { name: 'tempat_lahir', label: 'Tempat Lahir', type: 'text', placeholder: 'Bandung' },                { name: 'tanggal_lahir', label: 'Tanggal Lahir', type: 'date' },                { name: 'jenis_kelamin', label: 'Jenis Kelamin', type: 'select', options: ['Laki-laki', 'Perempuan'] },                { name: 'alamat', label: 'Alamat Lengkap', type: 'textarea', placeholder: 'Jl. Merdeka No. 25 RT 002 RW 003' },                { name: 'jenis_usaha', label: 'Jenis Usaha', type: 'text', placeholder: 'Warung Kelontong' },                { name: 'alamat_usaha', label: 'Alamat Usaha', type: 'textarea', placeholder: 'Jl. Pasar No. 12' },                { name: 'tanggal_surat', label: 'Tanggal Surat', type: 'date' }            ],            sket_tidak_mampu: [                { name: 'nama_lengkap', label: 'Nama Lengkap', type: 'text', placeholder: 'Bambang Sutrisno' },                { name: 'nik', label: 'NIK', type: 'text', placeholder: '3201234567890123' },                { name: 'tempat_lahir', label: 'Tempat Lahir', type: 'text', placeholder: 'Surabaya' },                { name: 'tanggal_lahir', label: 'Tanggal Lahir', type: 'date' },                { name: 'jenis_kelamin', label: 'Jenis Kelamin', type: 'select', options: ['Laki-laki', 'Perempuan'] },                { name: 'pekerjaan', label: 'Pekerjaan', type: 'text', placeholder: 'Buruh Harian' },                { name: 'alamat', label: 'Alamat Lengkap', type: 'textarea', placeholder: 'Jl. Kenanga No. 5 RT 003 RW 001' },                { name: 'keperluan', label: 'Keperluan', type: 'text', placeholder: 'Berobat di Rumah Sakit' },                { name: 'tanggal_surat', label: 'Tanggal Surat', type: 'date' }            ],            sket_kelahiran: [                { name: 'nama_bayi', label: 'Nama Bayi', type: 'text', placeholder: 'Ahmad Fauzi' },                { name: 'jenis_kelamin_bayi', label: 'Jenis Kelamin Bayi', type: 'select', options: ['Laki-laki', 'Perempuan'] },                { name: 'tanggal_lahir', label: 'Tanggal Lahir', type: 'date' },                { name: 'tempat_lahir', label: 'Tempat Lahir', type: 'text', placeholder: 'Rumah Sakit Umum' },                { name: 'nama_ayah', label: 'Nama Ayah', type: 'text', placeholder: 'Budi Santoso' },                { name: 'nik_ayah', label: 'NIK Ayah', type: 'text', placeholder: '3201234567890123' },                { name: 'nama_ibu', label: 'Nama Ibu', type: 'text', placeholder: 'Siti Nurhaliza' },                { name: 'nik_ibu', label: 'NIK Ibu', type: 'text', placeholder: '3201234567890124' },                { name: 'alamat_ortu', label: 'Alamat Orang Tua', type: 'textarea', placeholder: 'Jl. Melati No. 15 RT 002 RW 004' },                { name: 'tanggal_surat', label: 'Tanggal Surat', type: 'date' }            ],            sket_kematian: [                { name: 'nama_almarhum', label: 'Nama Almarhum/Almarhumah', type: 'text', placeholder: 'H. Sutrisno' },                { name: 'nik_almarhum', label: 'NIK', type: 'text', placeholder: '3201234567890123' },                { name: 'jenis_kelamin', label: 'Jenis Kelamin', type: 'select', options: ['Laki-laki', 'Perempuan'] },                { name: 'tempat_lahir', label: 'Tempat Lahir', type: 'text', placeholder: 'Jakarta' },                { name: 'tanggal_lahir', label: 'Tanggal Lahir', type: 'date' },                { name: 'tanggal_meninggal', label: 'Tanggal Meninggal', type: 'date' },                { name: 'tempat_meninggal', label: 'Tempat Meninggal', type: 'text', placeholder: 'Rumah Sakit' },                { name: 'sebab_meninggal', label: 'Sebab Meninggal', type: 'text', placeholder: 'Sakit' },                { name: 'alamat', label: 'Alamat Terakhir', type: 'textarea', placeholder: 'Jl. Anggrek No. 20 RT 001 RW 002' },                { name: 'nama_pelapor', label: 'Nama Pelapor', type: 'text', placeholder: 'Budi Santoso' },                { name: 'hubungan_pelapor', label: 'Hubungan dengan Almarhum', type: 'text', placeholder: 'Anak' },                { name: 'tanggal_surat', label: 'Tanggal Surat', type: 'date' }            ],            sket_penghasilan: [                { name: 'nama_lengkap', label: 'Nama Lengkap', type: 'text', placeholder: 'Andi Wijaya' },                { name: 'nik', label: 'NIK', type: 'text', placeholder: '3201234567890123' },                { name: 'tempat_lahir', label: 'Tempat Lahir', type: 'text', placeholder: 'Jakarta' },                { name: 'tanggal_lahir', label: 'Tanggal Lahir', type: 'date' },                { name: 'jenis_kelamin', label: 'Jenis Kelamin', type: 'select', options: ['Laki-laki', 'Perempuan'] },                { name: 'pekerjaan', label: 'Pekerjaan', type: 'text', placeholder: 'Wiraswasta' },                { name: 'alamat', label: 'Alamat Lengkap', type: 'textarea', placeholder: 'Jl. Mawar No. 10 RT 001 RW 005' },                { name: 'penghasilan', label: 'Penghasilan Per Bulan', type: 'text', placeholder: 'Rp 5.000.000' },                { name: 'keperluan', label: 'Keperluan', type: 'text', placeholder: 'Pengajuan KPR' },                { name: 'tanggal_surat', label: 'Tanggal Surat', type: 'date' }            ]        };        const jenisInfo = {            sk_rt: { icon: 'ğŸ‘¤', title: 'SK Pengangkatan RT', subtitle: 'Surat Keputusan RT' },            sk_rw: { icon: 'ğŸ‘¥', title: 'SK Pengangkatan RW', subtitle: 'Surat Keputusan RW' },            sk_perangkat: { icon: 'ï¿½ï¿½', title: 'SK Pengangkatan Perangkat', subtitle: 'Surat Keputusan Perangkat Desa' },            sk_karang_taruna: { icon: 'ğŸ¯', title: 'SK Karang Taruna', subtitle: 'Surat Keputusan Karang Taruna' },            sk_pkk: { icon: 'ğŸ‘©', title: 'SK PKK', subtitle: 'Surat Keputusan PKK' },            sk_bumdes: { icon: 'ğŸ¢', title: 'SK BUMDes', subtitle: 'Surat Keputusan BUMDes' },            sket_domisili: { icon: 'ğŸ ', title: 'Surat Keterangan Domisili', subtitle: 'Keterangan Tempat Tinggal' },            sket_usaha: { icon: 'ğŸª', title: 'Surat Keterangan Usaha', subtitle: 'Keterangan Memiliki Usaha' },            sket_tidak_mampu: { icon: 'ğŸ¤', title: 'Surat Keterangan Tidak Mampu', subtitle: 'Keterangan Ekonomi Lemah' },            sket_kelahiran: { icon: 'ğŸ‘¶', title: 'Surat Keterangan Kelahiran', subtitle: 'Keterangan Kelahiran Bayi' },            sket_kematian: { icon: 'ğŸ•Šï¸', title: 'Surat Keterangan Kematian', subtitle: 'Keterangan Kematian' },            sket_penghasilan: { icon: 'ğŸ’°', title: 'Surat Keterangan Penghasilan', subtitle: 'Keterangan Penghasilan' }        };        // Navigation functions        function showSection(sectionId) {            document.querySelectorAll('[id$="Section"]').forEach(section => {                section.classList.add('hidden');            });            document.getElementById(sectionId).classList.remove('hidden');            if (sectionId === 'homeSection') {                document.getElementById('mainNav').classList.remove('hidden');            }        }        function showKategori(kategori) {            currentKategori = kategori;            showSection('kategoriSection');            document.getElementById('skKategori').classList.add('hidden');            document.getElementById('sketKategori').classList.add('hidden');                        if (kategori === 'sk') {                document.getElementById('skKategori').classList.remove('hidden');                renderCustomTemplates('sk');            } else {                document.getElementById('sketKategori').classList.remove('hidden');                renderCustomTemplates('sket');            }        }        function renderCustomTemplates(kategori) {            const gridId = kategori === 'sk' ? 'skTemplateGrid' : 'sketTemplateGrid';            const grid = document.getElementById(gridId);                        // Remove existing custom templates            const customCards = grid.querySelectorAll('.custom-template-card');            customCards.forEach(card => card.remove());                        // Add custom templates            customTemplates[kategori].forEach(template => {                const card = document.createElement('div');                card.className = 'custom-template-card bg-white rounded-xl shadow-lg p-6 card-hover cursor-pointer border-2 border-purple-300';                card.onclick = () => pilihJenisSurat(template.id);                card.innerHTML = `                    <div class="flex justify-between items-start mb-3">                        <div class="text-5xl">${template.icon}</div>                        <button onclick="event.stopPropagation(); deleteTemplate('${kategori}', '${template.id}')" class="text-red-500 hover:text-red-700 text-xl" title="Hapus Template">                            ğŸ—‘ï¸                        </button>                    </div>                    <h3 class="text-xl font-bold text-gray-800 mb-2">${template.name}</h3>                    <p class="text-gray-600 text-sm">${template.desc}</p>                    <div class="mt-2">                        <span class="inline-block bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded">Custom</span>                    </div>                `;                grid.appendChild(card);            });        }        function showAddTemplateModal(kategori) {            currentModalKategori = kategori;            document.getElementById('addTemplateModal').classList.remove('hidden');            // Reset form            document.getElementById('newTemplateIcon').value = '';            document.getElementById('newTemplateName').value = '';            document.getElementById('newTemplateDesc').value = '';        }        function closeAddTemplateModal() {            document.getElementById('addTemplateModal').classList.add('hidden');        }        async function saveNewTemplate() {            const icon = document.getElementById('newTemplateIcon').value.trim();            const name = document.getElementById('newTemplateName').value.trim();            const desc = document.getElementById('newTemplateDesc').value.trim();                        if (!icon || !name || !desc) {                showToast('âš ï¸ Harap isi semua field!', 'error');                return;            }                        const templateId = `${currentModalKategori}_custom_${Date.now()}`;            const newTemplate = {                id: templateId,                icon: icon,                name: name,                desc: desc,                kategori: currentModalKategori            };                        customTemplates[currentModalKategori].push(newTemplate);                        // Add to jenisInfo            jenisInfo[templateId] = {                icon: icon,                title: name,                subtitle: desc            };                        // Add default form template            formTemplates[templateId] = [                { name: 'nama_lengkap', label: 'Nama Lengkap', type: 'text', placeholder: 'Nama lengkap' },                { name: 'nik', label: 'NIK', type: 'text', placeholder: '3201234567890123' },                { name: 'tempat_lahir', label: 'Tempat Lahir', type: 'text', placeholder: 'Jakarta' },                { name: 'tanggal_lahir', label: 'Tanggal Lahir', type: 'date' },                { name: 'jenis_kelamin', label: 'Jenis Kelamin', type: 'select', options: ['Laki-laki', 'Perempuan'] },                { name: 'pekerjaan', label: 'Pekerjaan', type: 'text', placeholder: 'Wiraswasta' },                { name: 'alamat', label: 'Alamat Lengkap', type: 'textarea', placeholder: 'Alamat lengkap' },                { name: 'keperluan', label: 'Keperluan', type: 'text', placeholder: 'Keperluan surat' },                { name: 'tanggal_surat', label: 'Tanggal Surat', type: 'date' }            ];                        // Save to database            if (window.dataSdk) {                const result = await window.dataSdk.create({                    id: `template_${templateId}`,                    jenis_surat: templateId,                    jenis_kategori: currentModalKategori,                    nomor_surat: '',                    nama_penerima: '',                    tanggal_surat: '',                    data_lengkap: '',                    created_at: new Date().toISOString(),                    is_custom_template: true,                    template_data: JSON.stringify(newTemplate)                });                                if (result.isOk) {                    showToast('âœ… Template berhasil disimpan!', 'success');                    closeAddTemplateModal();                    renderCustomTemplates(currentModalKategori);                } else {                    showToast('âŒ Gagal menyimpan template', 'error');                }            }        }        async function deleteTemplate(kategori, templateId) {            // Show inline confirmation            const confirmDiv = document.createElement('div');            confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';            confirmDiv.innerHTML = `                <div class="bg-white rounded-xl p-6 max-w-md mx-4">                    <p class="text-lg font-bold text-gray-800 mb-4">âš ï¸ Hapus template ini?</p>                    <p class="text-gray-600 mb-6">Template yang dihapus tidak dapat dikembalikan.</p>                    <div class="flex gap-3">                        <button id="confirmDeleteTemplate" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-medium">                            Ya, Hapus                        </button>                        <button id="cancelDeleteTemplate" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 font-medium">                            Batal                        </button>                    </div>                </div>            `;                        document.body.appendChild(confirmDiv);                        document.getElementById('confirmDeleteTemplate').onclick = async () => {                // Find and delete from database                const dbEntry = allSuratData.find(s => s.jenis_surat === templateId && s.is_custom_template === true);                if (dbEntry && window.dataSdk) {                    const result = await window.dataSdk.delete(dbEntry);                    if (result.isOk) {                        customTemplates[kategori] = customTemplates[kategori].filter(t => t.id !== templateId);                        delete jenisInfo[templateId];                        delete formTemplates[templateId];                        renderCustomTemplates(kategori);                        showToast('âœ… Template berhasil dihapus', 'success');                    } else {                        showToast('âŒ Gagal menghapus template', 'error');                    }                }                document.body.removeChild(confirmDiv);            };                        document.getElementById('cancelDeleteTemplate').onclick = () => {                document.body.removeChild(confirmDiv);            };        }        function showToast(message, type = 'info') {            const toast = document.createElement('div');            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';            toast.className = `fixed top-20 right-6 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in`;            toast.textContent = message;            document.body.appendChild(toast);                        setTimeout(() => {                toast.style.opacity = '0';                toast.style.transition = 'opacity 0.3s';                setTimeout(() => document.body.removeChild(toast), 300);            }, 3000);        }        function backToHome() {            showSection('homeSection');            updateStatistics();        }        function backToKategori() {            showSection('kategoriSection');        }        function pilihJenisSurat(jenis) {            currentJenisSurat = jenis;            const info = jenisInfo[jenis];            document.getElementById('formIcon').textContent = info.icon;            document.getElementById('formTitle').textContent = info.title;            document.getElementById('formSubtitle').textContent = info.subtitle;                        generateNomorSurat();            buildForm();            showSection('formSection');        }        // Generate nomor surat otomatis        function generateNomorSurat() {            const kategori = currentJenisSurat.startsWith('sk_') ? 'sk' : 'sket';            const counter = nomorSuratCounter[kategori] + 1;            const tahun = new Date().getFullYear();            const prefix = kategori === 'sk' ? 'SK' : 'SKET';                        let subfix = '';            if (currentJenisSurat === 'sk_rt') subfix = 'RT';            else if (currentJenisSurat === 'sk_rw') subfix = 'RW';            else if (currentJenisSurat === 'sk_perangkat') subfix = 'PERANGKAT';            else if (currentJenisSurat === 'sk_karang_taruna') subfix = 'KARANGTARUNA';            else if (currentJenisSurat === 'sk_pkk') subfix = 'PKK';            else if (currentJenisSurat === 'sk_bumdes') subfix = 'BUMDES';            else if (currentJenisSurat === 'sket_domisili') subfix = 'DOMISILI';            else if (currentJenisSurat === 'sket_usaha') subfix = 'USAHA';            else if (currentJenisSurat === 'sket_tidak_mampu') subfix = 'TM';            else if (currentJenisSurat === 'sket_kelahiran') subfix = 'LAHIR';            else if (currentJenisSurat === 'sket_kematian') subfix = 'MATI';            else if (currentJenisSurat === 'sket_penghasilan') subfix = 'GAJI';                        const nomorSurat = `${String(counter).padStart(3, '0')}/${prefix}-${subfix}/${tahun}`;            document.getElementById('nomorSuratAuto').value = nomorSurat;        }        // Build form        function buildForm() {            const fields = formTemplates[currentJenisSurat];            let html = '<div class="space-y-4">';                        fields.forEach(field => {                html += `<div>                    <label class="block text-sm font-semibold text-gray-700 mb-2">${field.label}</label>`;                                if (field.type === 'textarea') {                    html += `<textarea                         id="${field.name}"                         class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition"                         rows="3"                        placeholder="${field.placeholder || ''}"                    ></textarea>`;                } else if (field.type === 'select') {                    html += `<select                         id="${field.name}"                         class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition"                    >`;                    field.options.forEach(opt => {                        html += `<option value="${opt}">${opt}</option>`;                    });                    html += `</select>`;                } else {                    html += `<input                         type="${field.type}"                         id="${field.name}"                         class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition"                         placeholder="${field.placeholder || ''}"                    />`;                }                                html += `</div>`;            });                        html += '</div>';            document.getElementById('formContainer').innerHTML = html;        }        // Format tanggal Indonesia        function formatTanggalIndonesia(dateString) {            const bulan = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',                           'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];            const date = new Date(dateString);            return `${date.getDate()} ${bulan[date.getMonth()]} ${date.getFullYear()}`;        }        // Generate surat content        async function generateSurat() {            const config = window.elementSdk ? window.elementSdk.config : defaultConfig;            const fields = formTemplates[currentJenisSurat];            const generateBtn = document.getElementById('generateBtn');                        // Show loading            generateBtn.classList.add('loading');            generateBtn.textContent = 'â³ Sedang membuat surat...';                        // Collect form data            formData = {};            fields.forEach(field => {                const element = document.getElementById(field.name);                formData[field.name] = element.value;            });            formData.nomor_surat = document.getElementById('nomorSuratAuto').value;            let html = generateKopSurat(config);            if (currentJenisSurat.startsWith('sk_')) {                html += generateSK(formData, config);            } else {                html += generateSuratKeterangan(formData, config);            }            document.getElementById('suratContent').innerHTML = html;                        // Save to database            const namaPenerima = formData.nama_rt || formData.nama_rw || formData.nama_perangkat ||                                formData.nama_pengurus || formData.nama_lengkap || formData.nama_bayi ||                                formData.nama_almarhum || '-';                        const tanggalSurat = formData.tanggal_sk || formData.tanggal_surat || new Date().toISOString().split('T')[0];                        const kategori = currentJenisSurat.startsWith('sk_') ? 'sk' : 'sket';            nomorSuratCounter[kategori]++;                        if (window.dataSdk) {                const result = await window.dataSdk.create({                    id: Date.now().toString(),                    jenis_surat: currentJenisSurat,                    jenis_kategori: kategori,                    nomor_surat: formData.nomor_surat,                    nama_penerima: namaPenerima,                    tanggal_surat: tanggalSurat,                    data_lengkap: JSON.stringify(formData),                    created_at: new Date().toISOString()                });                if (!result.isOk) {                    console.error('Failed to save:', result.error);                }            }                        generateBtn.classList.remove('loading');            generateBtn.textContent = 'âœ¨ Generate Surat';                        showSection('previewSection');        }        function generateKopSurat(config) {            const logoHtml = config.logo_url ?                 `<img src="${config.logo_url}" alt="Logo Desa" style="width: 80px; height: 80px; object-fit: contain;" onerror="this.style.display='none';" />` :                 '';                        return `                <div style="display: flex; align-items: center; border-bottom: 3px solid black; padding-bottom: 15px; margin-bottom: 20px;">                    ${logoHtml}                    <div style="flex: 1; text-align: center;">                        <h2 style="margin: 0; font-size: 18px; font-weight: bold;">PEMERINTAH ${config.kabupaten_name.toUpperCase()}</h2>                        <h3 style="margin: 5px 0; font-size: 16px; font-weight: bold;">KECAMATAN ${config.kecamatan_name.toUpperCase()}</h3>                        <h3 style="margin: 5px 0; font-size: 16px; font-weight: bold;">${config.desa_name.toUpperCase()}</h3>                        <p style="margin: 5px 0; font-size: 12px;">${config.alamat_kantor}, Kode Pos: ${config.kode_pos}</p>                    </div>                    ${logoHtml ? '<div style="width: 80px;"></div>' : ''}                </div>            `;        }        function generateSK(data, config) {            let html = `                <div style="text-align: center; margin: 30px 0;">                    <h3 style="text-decoration: underline; font-weight: bold; font-size: 16px;">SURAT KEPUTUSAN</h3>                    <p>Nomor: ${data.nomor_surat}</p>                </div>            `;            let tentang = '';            let namaOrang = '';            let nikOrang = '';            let jabatanOrang = '';                        if (currentJenisSurat === 'sk_rt') {                tentang = `PENGANGKATAN KETUA RT ${data.rt_number} RW ${data.rw_number}`;                namaOrang = data.nama_rt;                nikOrang = data.nik_rt;                jabatanOrang = `Ketua RT ${data.rt_number} RW ${data.rw_number}`;            } else if (currentJenisSurat === 'sk_rw') {                tentang = `PENGANGKATAN KETUA RW ${data.rw_number}`;                namaOrang = data.nama_rw;                nikOrang = data.nik_rw;                jabatanOrang = `Ketua RW ${data.rw_number}`;            } else if (currentJenisSurat === 'sk_perangkat') {                tentang = `PENGANGKATAN ${data.jabatan.toUpperCase()}`;                namaOrang = data.nama_perangkat;                nikOrang = data.nik_perangkat;                jabatanOrang = data.jabatan;            } else if (currentJenisSurat === 'sk_karang_taruna') {                tentang = `PENGANGKATAN PENGURUS KARANG TARUNA`;                namaOrang = data.nama_pengurus;                nikOrang = data.nik_pengurus;                jabatanOrang = data.jabatan;            } else if (currentJenisSurat === 'sk_pkk') {                tentang = `PENGANGKATAN PENGURUS PKK`;                namaOrang = data.nama_pengurus;                nikOrang = data.nik_pengurus;                jabatanOrang = data.jabatan;            } else if (currentJenisSurat === 'sk_bumdes') {                tentang = `PENGANGKATAN PENGURUS BUMDES`;                namaOrang = data.nama_pengurus;                nikOrang = data.nik_pengurus;                jabatanOrang = data.jabatan;            }            html += `                <div style="margin: 20px 0; text-align: center; font-weight: bold;">                    TENTANG<br/>                    ${tentang}                </div>                <div style="margin: 20px 0;">                    <p style="margin: 10px 0;">Menimbang:</p>                    <p style="margin-left: 30px;">Bahwa untuk kelancaran dan ketertiban penyelenggaraan pemerintahan, perlu mengangkat ${jabatanOrang}.</p>                                        <p style="margin: 20px 0 10px 0;">Mengingat:</p>                    <p style="margin-left: 30px;">Peraturan Perundang-undangan yang berlaku.</p>                                        <p style="margin: 30px 0 10px 0; text-align: center; font-weight: bold;">MEMUTUSKAN</p>                                        <p style="margin: 10px 0;">PERTAMA:</p>                    <p style="margin-left: 30px;">Mengangkat Saudara/Saudari <strong>${namaOrang}</strong> (NIK: ${nikOrang}) sebagai ${jabatanOrang}.</p>                                        <p style="margin: 10px 0;">KEDUA:</p>                    <p style="margin-left: 30px;">Masa bakti selama ${data.masa_bakti} tahun terhitung sejak tanggal ditetapkan.</p>                                        <p style="margin: 10px 0;">KETIGA:</p>                    <p style="margin-left: 30px;">Keputusan ini berlaku sejak tanggal ditetapkan.</p>                </div>                                <div style="margin-top: 50px; text-align: right; margin-right: 50px;">                    <p>Ditetapkan di: ${config.desa_name}</p>                    <p>Pada tanggal: ${formatTanggalIndonesia(data.tanggal_sk)}</p>                    <p style="margin-top: 10px; font-weight: bold;">Kepala Desa</p>                    <div style="height: 80px;"></div>                    <p style="font-weight: bold; text-decoration: underline;">${config.nama_kepala_desa}</p>                </div>            `;            return html;        }        function generateSuratKeterangan(data, config) {            let html = `                <div style="text-align: center; margin: 30px 0;">                    <h3 style="text-decoration: underline; font-weight: bold; font-size: 16px;">SURAT KETERANGAN</h3>                    <p>Nomor: ${data.nomor_surat}</p>                </div>            `;            html += `                <div style="margin: 30px 0;">                    <p style="margin-bottom: 20px;">Yang bertanda tangan di bawah ini Kepala ${config.desa_name}, ${config.kecamatan_name}, ${config.kabupaten_name}, menerangkan bahwa:</p>            `;            if (currentJenisSurat === 'sket_kelahiran') {                html += `                    <p style="margin: 20px 0;">Telah lahir seorang bayi dengan keterangan sebagai berikut:</p>                                        <table style="margin: 20px 0; width: 100%;">                        <tr>                            <td style="width: 200px; padding: 5px 0;">Nama Bayi</td>                            <td style="width: 20px;">:</td>                            <td style="font-weight: bold;">${data.nama_bayi}</td>                        </tr>                        <tr>                            <td style="padding: 5px 0;">Jenis Kelamin</td>                            <td>:</td>                            <td>${data.jenis_kelamin_bayi}</td>                        </tr>                        <tr>                            <td style="padding: 5px 0;">Tanggal Lahir</td>                            <td>:</td>                            <td>${formatTanggalIndonesia(data.tanggal_lahir)}</td>                        </tr>                        <tr>                            <td style="padding: 5px 0;">Tempat Lahir</td>                            <td>:</td>                            <td>${data.tempat_lahir}</td>                        </tr>                    </table>                                        <p style="margin: 20px 0;">Anak dari pasangan:</p>                                        <table style="margin: 20px 0; width: 100%;">                        <tr>                            <td style="width: 200px; padding: 5px 0;">Nama Ayah</td>                            <td style="width: 20px;">:</td>                            <td style="font-weight: bold;">${data.nama_ayah}</td>                        </tr>                        <tr>                            <td style="padding: 5px 0;">NIK Ayah</td>                            <td>:</td>                            <td>${data.nik_ayah}</td>                        </tr>                        <tr>                            <td style="padding: 5px 0;">Nama Ibu</td>                            <td>:</td>                            <td style="font-weight: bold;">${data.nama_ibu}</td>                        </tr>                        <tr>                            <td style="padding: 5px 0;">NIK Ibu</td>                            <td>:</td>                            <td>${data.nik_ibu}</td>                        </tr>                        <tr>                            <td style="padding: 5px 0;">Alamat</td>                            <td>:</td>                            <td>${data.alamat_ortu}</td>                        </tr>                    </table>                                        <p style="margin: 20px 0;">Demikian surat keterangan ini dibuat dengan sebenarnya.</p>                `;            } else if (currentJenisSurat === 'sket_kematian') {                html += `                    <table style="margin: 20px 0; width: 100%;">                        <tr>                            <td style="width: 200px; padding: 5px 0;">Nama Lengkap</td>                            <td style="width: 20px;">:</td>                            <td style="font-weight: bold;">${data.nama_almarhum}</td>                        </tr>                        <tr>                            <td style="padding: 5px 0;">NIK</td>                            <td>:</td>                            <td>${data.nik_almarhum}</td>                        </tr>                        <tr>                            <td style="padding: 5px 0;">Jenis Kelamin</td>                            <td>:</td>                            <td>${data.jenis_kelamin}</td>                        </tr>                        <tr>                            <td style="padding: 5px 0;">Tempat, Tanggal Lahir</td>                            <td>:</td>                            <td>${data.tempat_lahir}, ${formatTanggalIndonesia(data.tanggal_lahir)}</td>                        </tr>                        <tr>                            <td style="padding: 5px 0;">Alamat Terakhir</td>                            <td>:</td>                            <td>${data.alamat}</td>                        </tr>                    </table>                                        <p style="margin: 20px 0;">Telah meninggal dunia pada:</p>                                        <table style="margin: 20px 0; width: 100%;">                        <tr>                            <td style="width: 200px; padding: 5px 0;">Tanggal Meninggal</td>                            <td style="width: 20px;">:</td>                            <td style="font-weight: bold;">${formatTanggalIndonesia(data.tanggal_meninggal)}</td>                        </tr>                        <tr>                            <td style="padding: 5px 0;">Tempat Meninggal</td>                            <td>:</td>                            <td>${data.tempat_meninggal}</td>                        </tr>                        <tr>                            <td style="padding: 5px 0;">Sebab Meninggal</td>                            <td>:</td>                            <td>${data.sebab_meninggal}</td>                        </tr>                    </table>                                        <p style="margin: 20px 0;">Surat keterangan ini dibuat berdasarkan laporan dari <strong>${data.nama_pelapor}</strong> (${data.hubungan_pelapor}).</p>                `;            } else {                html += `                    <table style="margin: 20px 0; width: 100%;">                        <tr>                            <td style="width: 200px; padding: 5px 0;">Nama Lengkap</td>                            <td style="width: 20px;">:</td>                            <td style="font-weight: bold;">${data.nama_lengkap}</td>                        </tr>                        <tr>                            <td style="padding: 5px 0;">NIK</td>                            <td>:</td>                            <td>${data.nik}</td>                        </tr>                        <tr>                            <td style="padding: 5px 0;">Tempat, Tanggal Lahir</td>                            <td>:</td>                            <td>${data.tempat_lahir}, ${formatTanggalIndonesia(data.tanggal_lahir)}</td>                        </tr>                        <tr>                            <td style="padding: 5px 0;">Jenis Kelamin</td>                            <td>:</td>                            <td>${data.jenis_kelamin}</td>                        </tr>                `;                if (currentJenisSurat === 'sket_domisili' || currentJenisSurat === 'sket_tidak_mampu' || currentJenisSurat === 'sket_penghasilan') {                    html += `                        <tr>                            <td style="padding: 5px 0;">Pekerjaan</td>                            <td>:</td>                            <td>${data.pekerjaan}</td>                        </tr>                    `;                }                html += `                        <tr>                            <td style="padding: 5px 0;">Alamat</td>                            <td>:</td>                            <td>${data.alamat}</td>                        </tr>                    </table>                `;                if (currentJenisSurat === 'sket_domisili') {                    html += `                        <p style="margin: 20px 0;">Adalah benar penduduk ${config.desa_name} dan berdomisili di alamat tersebut di atas.</p>                        <p style="margin: 20px 0;">Surat keterangan ini dibuat untuk keperluan <strong>${data.keperluan}</strong>.</p>                    `;                } else if (currentJenisSurat === 'sket_usaha') {                    html += `                        <p style="margin: 20px 0;">Adalah benar penduduk ${config.desa_name} yang memiliki usaha:</p>                                                <table style="margin: 20px 0; width: 100%;">                            <tr>                                <td style="width: 200px; padding: 5px 0;">Jenis Usaha</td>                                <td style="width: 20px;">:</td>                                <td style="font-weight: bold;">${data.jenis_usaha}</td>                            </tr>                            <tr>                                <td style="padding: 5px 0;">Alamat Usaha</td>                                <td>:</td>                                <td>${data.alamat_usaha}</td>                            </tr>                        </table>                                                <p style="margin: 20px 0;">Surat keterangan ini dibuat dengan sebenarnya.</p>                    `;                } else if (currentJenisSurat === 'sket_tidak_mampu') {                    html += `                        <p style="margin: 20px 0;">Adalah benar penduduk ${config.desa_name} yang tergolong <strong>keluarga tidak mampu</strong> berdasarkan data ekonomi yang kami miliki.</p>                        <p style="margin: 20px 0;">Surat keterangan ini dibuat untuk keperluan <strong>${data.keperluan}</strong>.</p>                    `;                } else if (currentJenisSurat === 'sket_penghasilan') {                    html += `                        <p style="margin: 20px 0;">Adalah benar penduduk ${config.desa_name} dengan penghasilan rata-rata per bulan sebesar <strong>${data.penghasilan}</strong>.</p>                        <p style="margin: 20px 0;">Surat keterangan ini dibuat untuk keperluan <strong>${data.keperluan}</strong>.</p>                    `;                }            }            html += `                    <p style="margin: 20px 0;">Demikian surat keterangan ini dibuat dengan sebenarnya untuk dapat dipergunakan sebagaimana mestinya.</p>                </div>                                <div style="margin-top: 50px; text-align: right; margin-right: 50px;">                    <p>${config.desa_name}, ${formatTanggalIndonesia(data.tanggal_surat)}</p>                    <p style="margin-top: 10px; font-weight: bold;">Kepala Desa</p>                    <div style="height: 80px;"></div>                    <p style="font-weight: bold; text-decoration: underline;">${config.nama_kepala_desa}</p>                </div>            `;            return html;        }        // Arsip functions        function renderArsip(dataList = allSuratData) {            const arsipList = document.getElementById('arsipList');            const emptyArsip = document.getElementById('emptyArsip');                        // Filter out custom templates from arsip            const filteredList = dataList.filter(s => !s.is_custom_template);                        if (filteredList.length === 0) {                arsipList.innerHTML = '';                emptyArsip.classList.remove('hidden');                return;            }                        emptyArsip.classList.add('hidden');                        let html = '';            filteredList.forEach(surat => {                const info = jenisInfo[surat.jenis_surat];                const bgColor = surat.jenis_kategori === 'sk' ? 'bg-blue-50' : 'bg-green-50';                const borderColor = surat.jenis_kategori === 'sk' ? 'border-blue-200' : 'border-green-200';                                html += `                    <div class="${bgColor} border-2 ${borderColor} rounded-lg p-4 flex justify-between items-center">                        <div class="flex items-center gap-4">                            <div class="text-3xl">${info.icon}</div>                            <div>                                <h4 class="font-bold text-gray-800">${info.title}</h4>                                <p class="text-sm text-gray-600">${surat.nama_penerima}</p>                                <p class="text-xs text-gray-500 mt-1">ğŸ“‹ ${surat.nomor_surat} â€¢ ï¿½ï¿½ï¿½ ${formatTanggalIndonesia(surat.tanggal_surat)}</p>                            </div>                        </div>                        <div class="flex gap-2">                            <button onclick="viewArsip('${surat.id}')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-medium">                                ğŸ‘ï¸ Lihat                            </button>                            <button onclick="deleteArsip('${surat.id}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium">                                ğŸ—‘ï¸ Hapus                            </button>                        </div>                    </div>                `;            });                        arsipList.innerHTML = html;        }        async function viewArsip(id) {            const surat = allSuratData.find(s => s.id === id);            if (!surat) return;                        currentJenisSurat = surat.jenis_surat;            formData = JSON.parse(surat.data_lengkap);                        const config = window.elementSdk ? window.elementSdk.config : defaultConfig;            let html = generateKopSurat(config);                        if (surat.jenis_kategori === 'sk') {                html += generateSK(formData, config);            } else {                html += generateSuratKeterangan(formData, config);            }                        document.getElementById('suratContent').innerHTML = html;            showSection('previewSection');        }        async function deleteArsip(id) {            const surat = allSuratData.find(s => s.id === id);            if (!surat) return;                        // Inline confirmation            const arsipList = document.getElementById('arsipList');            const confirmHtml = `                <div class="bg-red-50 border-2 border-red-300 rounded-lg p-6 text-center">                    <p class="text-lg font-bold text-red-700 mb-4">âš ï¸ Yakin ingin menghapus surat ini?</p>                    <p class="text-gray-600 mb-4">${surat.nomor_surat} - ${surat.nama_penerima}</p>                    <div class="flex gap-3 justify-center">                        <button onclick="confirmDeleteArsip('${id}')" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">                            Ya, Hapus                        </button>                        <button onclick="renderArsip()" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-medium">                            Batal                        </button>                    </div>                </div>            `;                        arsipList.insertAdjacentHTML('afterbegin', confirmHtml);        }        async function confirmDeleteArsip(id) {            if (!window.dataSdk) return;                        const surat = allSuratData.find(s => s.id === id);            if (!surat) return;                        const result = await window.dataSdk.delete(surat);            if (result.isOk) {                renderArsip();            } else {                const arsipList = document.getElementById('arsipList');                arsipList.insertAdjacentHTML('afterbegin', `                    <div class="bg-red-100 border-2 border-red-400 rounded-lg p-4 text-center text-red-700 mb-3">                        Gagal menghapus surat. Silakan coba lagi.                    </div>                `);                setTimeout(() => renderArsip(), 2000);            }        }        function filterArsip() {            const kategoriFilter = document.getElementById('filterKategori').value;            const searchText = document.getElementById('searchArsip').value.toLowerCase();                        let filtered = allSuratData;                        if (kategoriFilter !== 'all') {                filtered = filtered.filter(s => s.jenis_kategori === kategoriFilter);            }                        if (searchText) {                filtered = filtered.filter(s =>                     s.nama_penerima.toLowerCase().includes(searchText) ||                    s.nomor_surat.toLowerCase().includes(searchText)                );            }                        renderArsip(filtered);        }        function updateStatistics() {            // Filter out custom templates            const actualSurat = allSuratData.filter(s => !s.is_custom_template);                        const skCount = actualSurat.filter(s => s.jenis_kategori === 'sk').length;            const sketCount = actualSurat.filter(s => s.jenis_kategori === 'sket').length;                        const thisMonth = new Date().getMonth();            const thisYear = new Date().getFullYear();            const bulanIniCount = actualSurat.filter(s => {                const date = new Date(s.created_at);                return date.getMonth() === thisMonth && date.getFullYear() === thisYear;            }).length;                        document.getElementById('statSK').textContent = skCount;            document.getElementById('statSKET').textContent = sketCount;            document.getElementById('statTotal').textContent = actualSurat.length;            document.getElementById('statBulanIni').textContent = bulanIniCount;        }        // Profil Management Functions        function showAddProfilModal() {            currentEditProfilId = null;            document.getElementById('profilModalTitle').textContent = 'â• Tambah Profil Instansi Baru';            document.getElementById('addProfilModal').classList.remove('hidden');                        // Reset form            document.getElementById('profilTipeInstansi').value = '';            document.getElementById('profilNama').value = '';            document.getElementById('profilDesaName').value = '';            document.getElementById('profilKecamatanName').value = '';            document.getElementById('profilKabupatenName').value = '';            document.getElementById('profilAlamatKantor').value = '';            document.getElementById('profilKodePos').value = '';            document.getElementById('profilNamaKepala').value = '';            document.getElementById('profilLogoUrl').value = '';                        // Reset tipe buttons            document.querySelectorAll('.tipe-btn').forEach(btn => {                btn.classList.remove('border-blue-500', 'bg-blue-100');                btn.classList.add('border-gray-300');            });                        document.getElementById('logoUrlContainer').classList.remove('hidden');        }        function closeAddProfilModal() {            document.getElementById('addProfilModal').classList.add('hidden');        }        function selectTipeInstansi(tipe) {            document.getElementById('profilTipeInstansi').value = tipe;                        // Update button styles            document.querySelectorAll('.tipe-btn').forEach(btn => {                btn.classList.remove('border-blue-500', 'bg-blue-100');                btn.classList.add('border-gray-300');            });                        const selectedBtn = document.querySelector(`.tipe-btn[data-tipe="${tipe}"]`);            selectedBtn.classList.remove('border-gray-300');            selectedBtn.classList.add('border-blue-500', 'bg-blue-100');                        // Update labels based on tipe            if (tipe === 'desa') {                document.getElementById('labelNamaInstansi').textContent = 'Nama Desa';                document.getElementById('labelNamaPejabat').textContent = 'Nama Kepala Desa';                document.getElementById('logoUrlContainer').classList.remove('hidden');            } else if (tipe === 'kelurahan') {                document.getElementById('labelNamaInstansi').textContent = 'Nama Kelurahan';                document.getElementById('labelNamaPejabat').textContent = 'Nama Lurah';                document.getElementById('logoUrlContainer').classList.add('hidden');            }        }        async function saveProfilData() {            const tipe = document.getElementById('profilTipeInstansi').value;            const nama = document.getElementById('profilNama').value.trim();            const desaName = document.getElementById('profilDesaName').value.trim();            const kecamatanName = document.getElementById('profilKecamatanName').value.trim();            const kabupatenName = document.getElementById('profilKabupatenName').value.trim();            const alamatKantor = document.getElementById('profilAlamatKantor').value.trim();            const kodePos = document.getElementById('profilKodePos').value.trim();            const namaKepala = document.getElementById('profilNamaKepala').value.trim();            const logoUrl = document.getElementById('profilLogoUrl').value.trim();                        if (!tipe || !nama || !desaName || !kecamatanName || !kabupatenName || !alamatKantor || !kodePos || !namaKepala) {                showToast('âš ï¸ Harap isi semua field wajib!', 'error');                return;            }                        const profilData = {                tipe_instansi: tipe,                nama_profil: nama,                desa_name: desaName,                kecamatan_name: kecamatanName,                kabupaten_name: kabupatenName,                alamat_kantor: alamatKantor,                kode_pos: kodePos,                nama_kepala_desa: namaKepala,                logo_url: tipe === 'kelurahan' ? 'GARUDA' : logoUrl,                is_active: allProfilData.length === 0 ? true : false            };                        if (window.dataSdk) {                if (currentEditProfilId) {                    // Update existing profil                    const existingProfil = allProfilData.find(p => p.id === currentEditProfilId);                    if (existingProfil) {                        const oldData = JSON.parse(existingProfil.profil_data);                        profilData.is_active = oldData.is_active;                                                const result = await window.dataSdk.update({                            ...existingProfil,                            profil_data: JSON.stringify(profilData)                        });                                                if (result.isOk) {                            showToast('âœ… Profil berhasil diupdate!', 'success');                            closeAddProfilModal();                        } else {                            showToast('âŒ Gagal mengupdate profil', 'error');                        }                    }                } else {                    // Create new profil                    const result = await window.dataSdk.create({                        id: `profil_${Date.now()}`,                        jenis_surat: '',                        jenis_kategori: 'profil',                        nomor_surat: '',                        nama_penerima: nama,                        tanggal_surat: new Date().toISOString(),                        data_lengkap: '',                        created_at: new Date().toISOString(),                        profil_data: JSON.stringify(profilData)                    });                                        if (result.isOk) {                        showToast('âœ… Profil berhasil disimpan!', 'success');                        closeAddProfilModal();                    } else {                        showToast('âŒ Gagal menyimpan profil', 'error');                    }                }            }        }        function renderProfilList() {            const profilList = document.getElementById('profilList');            const emptyProfil = document.getElementById('emptyProfil');                        if (allProfilData.length === 0) {                profilList.innerHTML = '';                emptyProfil.classList.remove('hidden');                return;            }                        emptyProfil.classList.add('hidden');                        let html = '';            allProfilData.forEach(profil => {                const profilData = JSON.parse(profil.profil_data);                const isActive = profilData.is_active === true;                const tipeIcon = profilData.tipe_instansi === 'desa' ? 'ğŸ˜ï¸' : 'ğŸ¦…';                const tipeLabel = profilData.tipe_instansi === 'desa' ? 'Desa' : 'Kelurahan';                                html += `                    <div class="bg-${isActive ? 'green' : 'gray'}-50 border-2 border-${isActive ? 'green' : 'gray'}-200 rounded-xl p-6">                        <div class="flex justify-between items-start mb-4">                            <div class="flex items-start gap-4">                                <div class="text-4xl">${tipeIcon}</div>                                <div>                                    <h4 class="font-bold text-gray-800 text-lg">${profilData.nama_profil}</h4>                                    <p class="text-sm text-gray-600 mb-2">                                        <span class="inline-block bg-${profilData.tipe_instansi === 'desa' ? 'blue' : 'purple'}-100 text-${profilData.tipe_instansi === 'desa' ? 'blue' : 'purple'}-700 px-2 py-1 rounded text-xs font-semibold">                                            ${tipeLabel}                                        </span>                                        ${isActive ? '<span class="ml-2 inline-block bg-green-500 text-white px-2 py-1 rounded text-xs font-semibold">âœ“ AKTIF</span>' : ''}                                    </p>                                    <p class="text-sm text-gray-700">${profilData.desa_name}</p>                                    <p class="text-xs text-gray-600">${profilData.kecamatan_name}, ${profilData.kabupaten_name}</p>                                    <p class="text-xs text-gray-500 mt-1">Pejabat: ${profilData.nama_kepala_desa}</p>                                </div>                            </div>                            <div class="flex gap-2">                                ${!isActive ? `<button onclick="setActiveProfile('${profil.id}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium">                                    âœ“ Aktifkan                                </button>` : ''}                                <button onclick="editProfil('${profil.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">                                    âœï¸ Edit                                </button>                                ${!isActive ? `<button onclick="deleteProfil('${profil.id}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium">                                    ğŸ—‘ï¸ Hapus                                </button>` : ''}                            </div>                        </div>                    </div>                `;            });                        profilList.innerHTML = html;        }        async function setActiveProfile(profilId) {            if (!window.dataSdk) return;                        // Deactivate all profiles            for (const profil of allProfilData) {                const profilData = JSON.parse(profil.profil_data);                profilData.is_active = false;                                await window.dataSdk.update({                    ...profil,                    profil_data: JSON.stringify(profilData)                });            }                        // Activate selected profile            const selectedProfil = allProfilData.find(p => p.id === profilId);            if (selectedProfil) {                const profilData = JSON.parse(selectedProfil.profil_data);                profilData.is_active = true;                                const result = await window.dataSdk.update({                    ...selectedProfil,                    profil_data: JSON.stringify(profilData)                });                                if (result.isOk) {                    activeProfilId = profilId;                                        // Update element SDK config                    if (window.elementSdk) {                        window.elementSdk.setConfig({                            desa_name: profilData.desa_name,                            kecamatan_name: profilData.kecamatan_name,                            kabupaten_name: profilData.kabupaten_name,                            alamat_kantor: profilData.alamat_kantor,                            kode_pos: profilData.kode_pos,                            nama_kepala_desa: profilData.nama_kepala_desa,                            logo_url: profilData.logo_url                        });                    }                                        showToast('âœ… Profil aktif berhasil diubah!', 'success');                }            }        }        function updateActiveProfilSelector() {            const selector = document.getElementById('activeProfilSelector');                        let html = '<option value="">Pilih Profil Aktif...</option>';            allProfilData.forEach(profil => {                const profilData = JSON.parse(profil.profil_data);                const isActive = profilData.is_active === true;                html += `<option value="${profil.id}" ${isActive ? 'selected' : ''}>${profilData.nama_profil} (${profilData.tipe_instansi === 'desa' ? 'Desa' : 'Kelurahan'})</option>`;            });                        selector.innerHTML = html;                        selector.onchange = async function() {                if (this.value) {                    await setActiveProfile(this.value);                }            };        }        function editProfil(profilId) {            const profil = allProfilData.find(p => p.id === profilId);            if (!profil) return;                        const profilData = JSON.parse(profil.profil_data);            currentEditProfilId = profilId;                        document.getElementById('profilModalTitle').textContent = 'âœï¸ Edit Profil Instansi';            document.getElementById('profilNama').value = profilData.nama_profil;            document.getElementById('profilDesaName').value = profilData.desa_name;            document.getElementById('profilKecamatanName').value = profilData.kecamatan_name;            document.getElementById('profilKabupatenName').value = profilData.kabupaten_name;            document.getElementById('profilAlamatKantor').value = profilData.alamat_kantor;            document.getElementById('profilKodePos').value = profilData.kode_pos;            document.getElementById('profilNamaKepala').value = profilData.nama_kepala_desa;            document.getElementById('profilLogoUrl').value = profilData.logo_url === 'GARUDA' ? '' : profilData.logo_url;                        selectTipeInstansi(profilData.tipe_instansi);                        document.getElementById('addProfilModal').classList.remove('hidden');        }        async function deleteProfil(profilId) {            const profil = allProfilData.find(p => p.id === profilId);            if (!profil) return;                        const profilData = JSON.parse(profil.profil_data);                        // Inline confirmation            const confirmDiv = document.createElement('div');            confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';            confirmDiv.innerHTML = `                <div class="bg-white rounded-xl p-6 max-w-md mx-4">                    <p class="text-lg font-bold text-gray-800 mb-4">âš ï¸ Hapus profil ini?</p>                    <p class="text-gray-600 mb-2">${profilData.nama_profil}</p>                    <p class="text-sm text-gray-500 mb-6">Profil yang dihapus tidak dapat dikembalikan.</p>                    <div class="flex gap-3">                        <button id="confirmDeleteProfil" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-medium">                            Ya, Hapus                        </button>                        <button id="cancelDeleteProfil" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 font-medium">                            Batal                        </button>                    </div>                </div>            `;                        document.body.appendChild(confirmDiv);                        document.getElementById('confirmDeleteProfil').onclick = async () => {                if (window.dataSdk) {                    const result = await window.dataSdk.delete(profil);                    if (result.isOk) {                        showToast('âœ… Profil berhasil dihapus', 'success');                    } else {                        showToast('âŒ Gagal menghapus profil', 'error');                    }                }                document.body.removeChild(confirmDiv);            };                        document.getElementById('cancelDeleteProfil').onclick = () => {                document.body.removeChild(confirmDiv);            };        }        // Navigation helper functions        function showProfilSection() {            showSection('profilSection');            renderProfilList();            updateActiveProfilSelector();        }        function showArsipSection() {            showSection('arsipSection');            renderArsip();        }        // Event listeners        document.getElementById('btnBuatSurat').addEventListener('click', () => backToHome());        document.getElementById('generateBtn').addEventListener('click', generateSurat);        document.getElementById('editBtn').addEventListener('click', () => {            showSection('formSection');        });        document.getElementById('printBtn').addEventListener('click', () => {            window.print();        });        document.getElementById('downloadPdfBtn').addEventListener('click', () => {            const element = document.getElementById('suratContent');            const opt = {                margin: 0,                filename: `surat_${formData.nomor_surat.replace(/\//g, '-')}.pdf`,                image: { type: 'jpeg', quality: 0.98 },                html2canvas: { scale: 2 },                jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }            };            html2pdf().set(opt).from(element).save();        });        document.getElementById('filterKategori').addEventListener('change', filterArsip);        document.getElementById('searchArsip').addEventListener('input', filterArsip);                document.getElementById('backFromPreview').addEventListener('click', () => {            backToHome();        });        // Data SDK initialization        const dataHandler = {            onDataChanged(data) {                allSuratData = data;                                // Separate profil data from surat data                allProfilData = data.filter(item => item.jenis_kategori === 'profil');                                // Find active profil                const activeProfil = allProfilData.find(p => {                    try {                        const profilData = JSON.parse(p.profil_data);                        return profilData.is_active === true;                    } catch (e) {                        return false;                    }                });                                if (activeProfil) {                    activeProfilId = activeProfil.id;                    const profilData = JSON.parse(activeProfil.profil_data);                                        // Update element SDK config if available                    if (window.elementSdk) {                        window.elementSdk.setConfig({                            desa_name: profilData.desa_name,                            kecamatan_name: profilData.kecamatan_name,                            kabupaten_name: profilData.kabupaten_name,                            alamat_kantor: profilData.alamat_kantor,                            kode_pos: profilData.kode_pos,                            nama_kepala_desa: profilData.nama_kepala_desa,                            logo_url: profilData.logo_url                        });                    }                }                                // Load custom templates                customTemplates = { sk: [], sket: [] };                data.forEach(item => {                    if (item.is_custom_template === true && item.template_data) {                        try {                            const template = JSON.parse(item.template_data);                            customTemplates[template.kategori].push(template);                                                        // Restore to jenisInfo and formTemplates                            if (!jenisInfo[template.id]) {                                jenisInfo[template.id] = {                                    icon: template.icon,                                    title: template.name,                                    subtitle: template.desc                                };                                                                formTemplates[template.id] = [                                    { name: 'nama_lengkap', label: 'Nama Lengkap', type: 'text', placeholder: 'Nama lengkap' },                                    { name: 'nik', label: 'NIK', type: 'text', placeholder: '3201234567890123' },                                    { name: 'tempat_lahir', label: 'Tempat Lahir', type: 'text', placeholder: 'Jakarta' },                                    { name: 'tanggal_lahir', label: 'Tanggal Lahir', type: 'date' },                                    { name: 'jenis_kelamin', label: 'Jenis Kelamin', type: 'select', options: ['Laki-laki', 'Perempuan'] },                                    { name: 'pekerjaan', label: 'Pekerjaan', type: 'text', placeholder: 'Wiraswasta' },                                    { name: 'alamat', label: 'Alamat Lengkap', type: 'textarea', placeholder: 'Alamat lengkap' },                                    { name: 'keperluan', label: 'Keperluan', type: 'text', placeholder: 'Keperluan surat' },                                    { name: 'tanggal_surat', label: 'Tanggal Surat', type: 'date' }                                ];                            }                        } catch (e) {                            console.error('Failed to parse template', e);                        }                    }                });                                // Update counter berdasarkan data terbaru (exclude templates and profil)                const skData = data.filter(s => s.jenis_kategori === 'sk' && !s.is_custom_template);                const sketData = data.filter(s => s.jenis_kategori === 'sket' && !s.is_custom_template);                                nomorSuratCounter.sk = skData.length;                nomorSuratCounter.sket = sketData.length;                                updateStatistics();                                if (document.getElementById('arsipSection').classList.contains('hidden') === false) {                    renderArsip();                }                                if (document.getElementById('profilSection').classList.contains('hidden') === false) {                    renderProfilList();                    updateActiveProfilSelector();                }            }        };        // Element SDK initialization        async function onConfigChange(config) {            if (document.getElementById('suratContent').innerHTML) {                let html = generateKopSurat(config);                                if (currentJenisSurat.startsWith('sk_')) {                    html += generateSK(formData, config);                } else {                    html += generateSuratKeterangan(formData, config);                }                                document.getElementById('suratContent').innerHTML = html;            }        }        // Initialize SDKs        (async function() {            if (window.dataSdk) {                const result = await window.dataSdk.init(dataHandler);                if (!result.isOk) {                    console.error('Failed to initialize data SDK');                }            }            if (window.elementSdk) {                window.elementSdk.init({                    defaultConfig,                    onConfigChange,                    mapToCapabilities: () => ({                        recolorables: [],                        borderables: [],                        fontEditable: undefined,                        fontSizeable: undefined                    }),                    mapToEditPanelValues: (config) => new Map([                        ["desa_name", config.desa_name || defaultConfig.desa_name],                        ["kecamatan_name", config.kecamatan_name || defaultConfig.kecamatan_name],                        ["kabupaten_name", config.kabupaten_name || defaultConfig.kabupaten_name],                        ["alamat_kantor", config.alamat_kantor || defaultConfig.alamat_kantor],                        ["kode_pos", config.kode_pos || defaultConfig.kode_pos],                        ["nama_kepala_desa", config.nama_kepala_desa || defaultConfig.nama_kepala_desa],                        ["logo_url", config.logo_url || defaultConfig.logo_url]                    ])                });            }        })();    </script>   </div>  </div> <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9be202ede1faf8de',t:'MTc2ODQ0NDg1OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body></html>
